name: Create BookStack Page on New Issue

on:
  issues:
    types: [opened]

jobs:
  createPage:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Create HTML and send to BookStack
        env:
          BOOKSTACK_API_ID: ${{ secrets.BOOKSTACK_API_ID }}
          BOOKSTACK_API_SECRET: ${{ secrets.BOOKSTACK_API_SECRET }}
          BOOKSTACK_URL: ${{ secrets.BOOKSTACK_URL }}
          BOOKSTACK_BOOK_ID: ${{ secrets.BOOKSTACK_BOOK_ID }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
        run: |
          mkdir page-generator
          cd page-generator
          npm init -y > /dev/null
          npm install marked node-fetch@2 > /dev/null

          cat > create-page.js << 'JS'
          const fetch = require('node-fetch');
          const marked = require('marked');

          const title = process.env.ISSUE_TITLE;
          const body = process.env.ISSUE_BODY || 'Нет описания';
          const url = process.env.ISSUE_URL;
          const bookId = process.env.BOOKSTACK_BOOK_ID;
          const apiBase = process.env.BOOKSTACK_URL;

          // конвертим markdown из issue в html
          const htmlBody = marked.parse(body);

          // собираем итоговый html
          const fullHtml =
            '<p><strong>Связанная задача (GitHub):</strong> <a href="' + url + '">' + url + '</a></p>\n' +
            htmlBody +
            '\n<p><strong>Метки:</strong> mobile, layout, github</p>';

          const payload = {
            name: title,
            book_id: Number(bookId),
            html: fullHtml,
          };

          // шлём в BookStack
          fetch(apiBase + '/api/pages', {
            method: 'POST',
            headers: {
              'Authorization': 'Token ' + process.env.BOOKSTACK_API_ID + ':' + process.env.BOOKSTACK_API_SECRET,
              'Content-Type': 'application/json',
              'bypass-tunnel-reminder': '1',
            },
            body: JSON.stringify(payload),
          })
            .then(async (res) => {
              const text = await res.text();
              console.log('Status:', res.status, res.statusText);
              console.log('Response body:', text);

              if (!res.ok) {
                // чтобы GitHub показал шаг как failed
                process.exit(1);
              } else {
                console.log('Page created successfully');
              }
            })
            .catch(err => {
              console.error('Request error:', err);
              process.exit(1);
            });
          JS

          node create-page.js
